<extend name="Public/base"/>
<block name="style">
	<css href="__JS__/jquery.icheck/skins/square/blue.css"/>
	<css href="__JS__/bootstrap.datetimepicker/css/bootstrap-datetimepicker.min.css" />
	<style type="text/css">
		.col-sm-3{
			width:185px;
		}
		.blue {
            table-layout:fixed;
        }
        .blue  td {
            word-wrap:break-word;
        }
	</style>
</block>
<block name="body">
	<div>
		<div class="page-head">
			<h2>异常资金流水</h2>
		</div>
		<div class="cl-mcont">
			<div class="row">
				<div class="col-md-12">
					<form class="shop-form" method="get" action="{:U('callbacklist')}">
					<div class="block-flat">
						<div class="header">
							<h3 class="hthin">{$meta_title}</h3>
						</div>
						<div class="content">
							<div class="col-sm-12">
								<div style="float: left;width: 100%;">
									<label class="pull-left control-label">支付方式</label>
									<div class="col-sm-2" >
										<select class="form-control" name="pay_platform" style="width: 100px;">
											<option value="">所有支付方式</option>
											<volist name="type_list" id="vo">
												<option value="{$vo.type}">{$vo.name}</option>
											</volist>
										</select>
									</div>
									<label class="pull-left control-label">是否实物</label>
									<div class="col-sm-2" >
										<select class="form-control" name="btnisshiwu" style="width: 100px;">
											<option value="">是否实物</option>
											<option value="1">实物</option>
											<option value="2">虚拟</option>
										</select>
									</div>
								<input type="hidden" value="{$pid}" name="pid"/>

								<label class="pull-left control-label">开始日期</br><a style="color:green">(支付时间)</a></label>
								<div class="col-sm-3">
									<div class="input-group date starttime" data-min-view="2" data-date-format="yyyy-mm-dd">
										<input type="text" name="starttime" class="form-control" value=""/>
										<!--<input type="text" name="starttime" class="form-control" value="{$Think.post.starttime|default=time_format(NOW_TIME-24*60*60*30,'Y-m-d')}"/>-->
										<span class="input-group-addon btn btn-primary"><span class="glyphicon glyphicon-remove" ></span></span>
										<span class="input-group-addon btn btn-primary"> <span class="glyphicon glyphicon-th"></span></span>

									</div>
								</div>
								<label class="pull-left control-label">结束日期</br><a style="color:green">(支付时间)</a></label>
								<div class="col-sm-3" >
									<div class="input-group date endtime" data-min-view="2" data-date-format="yyyy-mm-dd">
										<input type="text" name="endtime" class="form-control" value=""/>
										<span class="input-group-addon btn btn-primary"><span class="glyphicon glyphicon-remove" ></span></span>
										<span class="input-group-addon btn btn-primary" ><span class="glyphicon glyphicon-th"></span></span>
									</div>
								</div>
							</div>

								<div style="float: left;width: 100%;">
									<label class="pull-left control-label">用 &nbsp;户&nbsp;名</label>

									<div class="col-sm-2">
										<input type="text" name="keyworduser" class="form-control" style="width: 100px;">
									</div>

									<label class="pull-left control-label">商品名称</label>

									<div class="col-sm-2">
										<input type="text" name="keywordshop" class="form-control" style="width: 100px;">
									</div>

									<label class="pull-left control-label">开始日期</br><a style="color:red">(开奖时间)</a></label>
									<div class="col-sm-3">
										<div class="input-group date kstarttime" data-min-view="2" data-date-format="yyyy-mm-dd">
											<input type="text" name="kstarttime" class="form-control" value=""/>
											<span class="input-group-addon btn btn-primary"><span class="glyphicon glyphicon-remove" ></span></span>
											<span class="input-group-addon btn btn-primary"> <span class="glyphicon glyphicon-th"></span></span>

										</div>
									</div>
									<label class="pull-left control-label">结束日期</br><a style="color:red">(开奖时间)</a></label>
									<div class="col-sm-3" >
										<div class="input-group date kendtime" data-min-view="2" data-date-format="yyyy-mm-dd">
											<input type="text" name="kendtime" class="form-control" value=""/>
											<span class="input-group-addon btn btn-primary"><span class="glyphicon glyphicon-remove" ></span></span>
											<span class="input-group-addon btn btn-primary" ><span class="glyphicon glyphicon-th"></span></span>
										</div>
									</div>



								</div>

								<div style="float: left;width: 100%;">

									<label class="pull-left control-label">推 &nbsp;荐&nbsp;码</label>
									<div class="col-sm-2">
										<input type="text" name="keyword_invitationid" class="form-control" style="width: 100px;">
									</div>

									<label class="pull-left control-label">渠道名称</label>
									<div class="btn-group col-sm-2">
										<button type="button" class="btn btn-default dropdown-toggle" id="btnchannelname"   data-toggle="dropdown">
											渠道名称 <span class="caret"></span>
										</button>
										<ul class="dropdown-menu" role="menu">
											<li><a  href="javascript:void(0)" onclick="myJsFunc('0','渠道名称');">渠道名称</a></li>
											<volist name="channelTree" id="vo">
												<li ><a href="javascript:void(0)" onclick="myJsFunc('{$vo['id']}','{$vo['channel_name']}');">{$vo.html}{$vo.channel_name}</a>
												</li>
											</volist>
										</ul>
									</div>
									<label class="pull-left control-label">活动状态</label>
									<div class="col-sm-2" >
										<select class="form-control" name="state" style="width: 100px;">
											<option value="">所有状态</option>
											<option value="0">进行中</option>
											<option value="1">开奖中</option>
											<option value="2">已开奖</option>
										</select>
									</div>
									<label class="pull-left control-label">支付是否回调</label>
									<div class="col-sm-2" >
										<select class="form-control" name="callback" style="width: 100px;">
											<option value="">所有状态</option>
											<option value="0">否</option>
											<option value="1">是</option>
										</select>
									</div>
									</div>

								<div style="float: left;width: 100%;margin-top: 10px">
									<div>
										<button type="button" id="search"
												url="{:U('callbacklist')}" class="btn btn-success">
											搜索
										</button>
									
										<button type="button"   url="{:U('exportCallback')}"  class="btn btn-success" id="btnExport">导出Excel</button>
									</div>
								</div>
							</div>
							<table class="no-border blue">
								<thead class="no-border">
								<tr>
									<th style="width:12%;">支付流水号</th>
									<th style="width:5%;">用户ID</th>
									<th style="width:10%;">用户名</th>
									<th style="width:10%;">商品期号</th>
									<th style="width:5%;">商品ID</th>
									<th style="width:10%;">商品名称</th>
									<th style="width:5%;">是否实物</th>
									<th style="width:10%;color:green;">支付时间</th>
									<th style="width:10%;color:red;">开奖时间</th>
									<th style="width:5%;">参与状态</th>
									<th style="width:5%;">活动状态</th>
									<th style="width:5%;">支付平台</th>
									<th style="width:5%;">渠道名称</th>
									<th style="width:5%;">推荐码</th>
									<th style="width:5%;">一级渠道名称</th>
									<th style="width:5%;">现金支付金额</th>
									<th style="width:5%;">金币支付金额</th>
									<!-- <th style="width:5%;">优惠现金金额</th>
									<th style="width:5%;">优惠金币金额</th> -->
									<th style="width:5%;">总支付金额</th>
									<th style="width:5%;">支付是否回调</th>
									<!-- <th style="width:5%;">红包id</th> -->
  								</tr>

								</thead>
								<notempty name="list">
									<tbody class="no-border-y">
									<volist name="list" id="vo">
										<tr>
											<td style="width:5%;">{$vo.pay_order_id}</td>
											<td style="width:5%;">{$vo.user_id}</td>
											<td style="width:5%;">{$vo.username}</td>
											<td style="width:5%;">{$vo.action_no}</td>
											<td style="width:5%;">{$vo.shop_id}</td>
											<td style="width:5%;">{$vo.shop_name}</td>
											<td style="width:5%;">{$vo['fictitious']==1?"实物":"虚拟"}</td>
											<td style="width:5%;">{$vo.order_time|date="Y-m-d H:i:s",###}</td>
											<td style="width:5%;"><empty name="vo.kaijang_time" > ---<else/> {$vo.kaijang_time|date="Y-m-d H:i:s",###}</empty>

											</td>
											<!--<td style="width:5%;">{$vo.kaijang_time|default="没有时间显示"|date="Y-m-d H:i:s",###}</td>-->
											<td style="width:5%;">{$vo.code|default="-"}</td>
											<td style="width:5%;">{:get_state($vo['state'])}</td>
											<td style="width:5%;">{:get_recharge($vo['pay_platform'])}</td>
											<td style="width:5%;">{$vo.channel_name}</td>
											<td style="width:5%;">{$vo.invitationid}</td>
											<td style="width:5%;">{$vo.root_name }</td>
											<td style="width:5%;">{$vo.cash}</td>
											<td style="width:5%;">{$vo.gold}</td>
											<!-- <td style="width:5%;">{$vo.discount_cash}</td>
											<td style="width:5%;">{$vo.discount_gold}</td> -->
											<td style="width:5%;">{$vo.pay_total}</td>
											<td style="width:5%;">{$vo['is_callback']==1?"是":"否"}</td>
											<!-- <td style="width:5%;"><notempty name="vo.red_id"><a href="#" class="opiframe" url="{:U('fundsinfo?id='.$vo['red_id'])}">{$vo.red_name}({$vo.red_id})</a></notempty></td> -->
										</tr>
									</volist>
									</tbody>
									<else/>
									<td colspan="4"> aOh! 暂时还没有内容! </td>
								</notempty>
							</table>
							<div class="content col-lg-12 pull-left">
								<div class="panel-foot text-center">
									<div class="page">{$_page}</div>
								</div>
							</div>
						</div>
					</div>
					</form>
				</div>
			</div>
		</div>
	</div>
</block>
<block name="script">
	<js href="__JS__/jquery.icheck/icheck.min.js"/>
	<js href="__JS__/bootstrap.datetimepicker/js/locales/bootstrap-datetimepicker.zh-CN.js" />
	<script type="text/javascript">
		$(document).ready(function(){
			$(".starttime").datetimepicker({autoclose: true,language: 'zh-CN'});
			$(".endtime").datetimepicker({autoclose: true,language: 'zh-CN'});
			$(".kstarttime").datetimepicker({autoclose: true,language: 'zh-CN'});
			$(".kendtime").datetimepicker({autoclose: true,language: 'zh-CN'});
			highlight_subnav('{:U('Finance/callbacklist')}');


			$('.opiframe').click(function () {
                layer.open({
                    type: 2,
                    title: '红包详情',
                    shadeClose: true,
                    maxmin: false, //开启最大化最小化按钮
                    area: ['850px', '610px'],
                    content: [$(this).attr('url'), 'no']
                });
            });
			//搜索功能
			$("#search").click(function () {
				var url = $(this).attr('url');
				var keyworduser=  $('input[name=keyworduser]').val();
				var keywordshop=  $('input[name=keywordshop]').val();
				var keyword_invitationid=  $('input[name=keyword_invitationid]').val();
				var pay_platform=  $('select[name=pay_platform]').val();
				var fictitious=  $('select[name=btnisshiwu]').val();
				var state=  $("select[name=state]").val();
				var callback=  $("select[name=callback]").val();
				//渠道名称
				var channelid= $('#btnchannelname').val();
				var channelname= $('#btnchannelname').text();
				var starttime=  $('input[name=starttime]').val();
				var endtime=    $('input[name=endtime]').val();
				var kstarttime=  $('input[name=kstarttime]').val();
				var kendtime=    $('input[name=kendtime]').val();
				var   query="keyworduser/"+keyworduser+"/keyword_invitationid/"+keyword_invitationid+"/keywordshop/"+keywordshop+"/state/"+state+"/pay_platform/"+pay_platform+"/fictitious/"+fictitious+"/channelid/"+channelid+"/channelname/"+channelname+"/starttime/"+starttime+"/endtime/"+endtime+"/kstarttime/"+kstarttime+"/kendtime/"+kendtime+'/callback/'+callback;
				url += '/' + query;
				window.location.href = url;
			});

			//导出功能
			$("#btnExport").click(function () {
				var url = $(this).attr('url');
				var keyworduser=  $('input[name=keyworduser]').val();
				var keywordshop=  $('input[name=keywordshop]').val();
				var keyword_invitationid=  $('input[name=keyword_invitationid]').val();
				var state=  $("select[name=state]").val();
				var pay_platform=  $('select[name=pay_platform]').val();
				var fictitious=  $('select[name=btnisshiwu]').val();
				var callback=  $("select[name=callback]").val();
				//渠道名称
				var channelid= $('#btnchannelname').val();
				var channelname= $('#btnchannelname').text();
				var starttime=  $('input[name=starttime]').val();
				var endtime=    $('input[name=endtime]').val();
				var kstarttime=  $('input[name=kstarttime]').val();
				var kendtime=    $('input[name=kendtime]').val();
				var   query="keyworduser/"+keyworduser+ "/keyword_invitationid/"+keyword_invitationid+ "/keywordshop/"+keywordshop+"/state/"+state+"/pay_platform/"+pay_platform+"/fictitious/"+fictitious+"/channelid/"+channelid+"/channelname/"+channelname+"/starttime/"+starttime+"/endtime/"+endtime+"/kstarttime/"+kstarttime+"/kendtime/"+kendtime+'/callback/'+callback;
				url += '/' + query;
				window.location.href = url;
			});
			fundsflowIndx.conditionarr();

		});

		var fundsflowIndx = {
			conditionarr: function () {
				var span='<span class="caret"></span>';
				var conditionarr =  JSON.parse('{$conditionarr}') ;
				var keyworduser=conditionarr['keyworduser'];
				if(keyworduser!=undefined){
					$('input[name=keyworduser]').val(keyworduser);
				}

				var keywordshop=conditionarr['keywordshop'];
				if(keywordshop!=undefined){
					$('input[name=keywordshop]').val(keywordshop);
				}

				var keyword_invitationid=conditionarr['keyword_invitationid'];
				if(keyword_invitationid!=undefined){
					$('input[name=keyword_invitationid]').val(keyword_invitationid);
				}

				$("select[name=state]").val(conditionarr['state']);
				$("select[name=callback]").val(conditionarr['callback']);

				var starttime=conditionarr['starttime'];
				if(starttime!=undefined){
					$('input[name=starttime]').val(starttime);
				}
				var endtime=conditionarr['endtime'];
				if(endtime!=undefined){
					$('input[name=endtime]').val( endtime);
				}

				var kstarttime=conditionarr['kstarttime'];
				if(kstarttime!=undefined){
					$('input[name=kstarttime]').val(kstarttime);
				}
				var kendtime=conditionarr['kendtime'];
				if(kendtime!=undefined){
					$('input[name=kendtime]').val( kendtime);
				}

				var pay_platform=conditionarr['pay_platform'];
				$('select[name=pay_platform]').val( pay_platform);
				

				var fictitious=conditionarr['fictitious'];
				if(fictitious!=undefined){
					$('select[name=btnisshiwu]').val( fictitious);
				}

				var channelname=conditionarr['channelname'];
				var channelid=conditionarr['channelid'];
				if(channelname!=undefined && channelid!= undefined){
					$('#btnchannelname').html(channelname+span);
					$('#btnchannelname').val(channelid);
				}
			}
		}
		function myJsFunc( id,name) {
			//拼装所有的查询、筛选条件   渠道等级、所有状态、搜索关键字
			var span='<span class="caret"></span>';
			$('#btnchannelname').html(name+span);
			$('#btnchannelname').val(id);
		}
	</script>
</block>